#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# DOL PRE-COMMIT HOOK
# ═══════════════════════════════════════════════════════════════════════════════
#
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#
# Checks before every commit:
# 1. Code formatted (cargo fmt)
# 2. No clippy warnings
# 3. All tests pass
# 4. DOL files parse
# 5. No TODO/FIXME without issue reference
#
# ═══════════════════════════════════════════════════════════════════════════════

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "═══════════════════════════════════════════════════════════════════════════════"
echo "                         DOL PRE-COMMIT CHECKS"
echo "═══════════════════════════════════════════════════════════════════════════════"
echo ""

FAILED=0

# ─────────────────────────────────────────────────────────────────────────────────
# CHECK 1: Format
# ─────────────────────────────────────────────────────────────────────────────────
echo -n "Checking format... "
if cargo fmt --check > /dev/null 2>&1; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
    echo "  Run: cargo fmt"
    FAILED=1
fi

# ─────────────────────────────────────────────────────────────────────────────────
# CHECK 2: Clippy
# ─────────────────────────────────────────────────────────────────────────────────
echo -n "Checking clippy... "
if cargo clippy --all-targets --all-features -- -D warnings > /dev/null 2>&1; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
    echo "  Run: cargo clippy --fix"
    FAILED=1
fi

# ─────────────────────────────────────────────────────────────────────────────────
# CHECK 3: Tests
# ─────────────────────────────────────────────────────────────────────────────────
echo -n "Running tests... "
if cargo test --lib --quiet > /dev/null 2>&1; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
    echo "  Run: cargo test --lib"
    FAILED=1
fi

# ─────────────────────────────────────────────────────────────────────────────────
# CHECK 4: DOL Parse
# ─────────────────────────────────────────────────────────────────────────────────
echo -n "Checking DOL files... "
if [ -d "dol" ]; then
    DOL_FAILED=0
    for f in dol/*.dol; do
        if ! cargo run --quiet --features cli --bin dol-check -- "$f" > /dev/null 2>&1; then
            DOL_FAILED=1
            break
        fi
    done
    if [ "$DOL_FAILED" -eq 0 ]; then
        echo -e "${GREEN}✓${NC}"
    else
        echo -e "${RED}✗${NC}"
        echo "  Run: make check"
        FAILED=1
    fi
else
    echo -e "${YELLOW}skipped${NC} (no dol/ directory)"
fi

# ─────────────────────────────────────────────────────────────────────────────────
# CHECK 5: TODO/FIXME
# ─────────────────────────────────────────────────────────────────────────────────
echo -n "Checking TODOs... "
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(rs|dol)$' || true)
if [ -n "$STAGED_FILES" ]; then
    # Check for TODO/FIXME without issue reference like TODO(#123) or FIXME(#456)
    BAD_TODOS=$(echo "$STAGED_FILES" | xargs grep -l -E '(TODO|FIXME)(?!\(#[0-9]+\))' 2>/dev/null || true)
    if [ -n "$BAD_TODOS" ]; then
        echo -e "${YELLOW}warning${NC}"
        echo "  TODOs without issue reference in:"
        echo "$BAD_TODOS" | sed 's/^/    /'
        echo "  Format: TODO(#123) or FIXME(#456)"
    else
        echo -e "${GREEN}✓${NC}"
    fi
else
    echo -e "${GREEN}✓${NC} (no staged files)"
fi

# ─────────────────────────────────────────────────────────────────────────────────
# CHECK 6: Commit message (if using commitlint style)
# ─────────────────────────────────────────────────────────────────────────────────
# Note: This check is for the commit message file if it exists
if [ -f ".git/COMMIT_EDITMSG" ]; then
    echo -n "Checking commit message... "
    MSG=$(head -1 .git/COMMIT_EDITMSG)
    if echo "$MSG" | grep -qE '^(feat|fix|test|docs|refactor|perf|ci|chore)\([a-z]+\): .+$'; then
        echo -e "${GREEN}✓${NC}"
    else
        echo -e "${YELLOW}warning${NC}"
        echo "  Expected format: type(scope): description"
        echo "  Types: feat, fix, test, docs, refactor, perf, ci, chore"
    fi
fi

# ─────────────────────────────────────────────────────────────────────────────────
# RESULT
# ─────────────────────────────────────────────────────────────────────────────────
echo ""
if [ "$FAILED" -eq 0 ]; then
    echo -e "${GREEN}All checks passed!${NC}"
    exit 0
else
    echo -e "${RED}Some checks failed. Please fix before committing.${NC}"
    echo ""
    echo "To skip (not recommended): git commit --no-verify"
    exit 1
fi
